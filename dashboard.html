<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard | RouteFlow London</title>
  <link rel="icon" href="images/New_Routflow_London_Logo.png" type="image/png" />
  <link href="https://fonts.googleapis.com/css2?family=Atkinson+Hyperlegible:wght@400;600&family=Inter:wght@400;600;800&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="dashboard.css" />
  <script src="theme.js" defer></script>
</head>
<body>
  <div id="navbar-container"></div>
  <main class="dashboard">
    <div class="dashboard-column">
      <section class="card profile-card">
        <img src="user-icon.png" alt="User Avatar" id="profileAvatar" />
        <div>
          <h2 id="welcomeTitle">Welcome</h2>
          <p id="profileInfo"></p>
        </div>
      </section>
      <section class="card" id="activityCard">
        <h2>Recent Activity</h2>
        <ul id="activityList" class="activity-list"></ul>
      </section>
    </div>
    <div class="dashboard-column">
      <section class="card">
        <h2>Your Favourites</h2>
        <div id="favouritesGrid" class="favourites-grid"></div>
      </section>
      <section class="card">
        <h2>Recents</h2>
        <ul id="recentsList" class="recents-list"></ul>
      </section>
    </div>
  </main>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDuedLuagA4IXc9ZMG9wvoak-sRrhtFZfo",
      authDomain: "routeflow-london.firebaseapp.com",
      projectId: "routeflow-london",
      storageBucket: "routeflow-london.firebasestorage.app",
      messagingSenderId: "368346241440",
      appId: "1:368346241440:web:7cc87d551420459251ecc5"
    };
    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
  </script>
  <script src="navbar-loader.js"></script>
  <script type="module">
    import {getFavourites, removeFavourite} from './favourites.js';
    import {getRecents} from './recents.js';
    import {inferFavouriteType, resolveFavouriteTitle, buildFavouriteMeta} from './favourite-utils.js';

    window.signOut = () => { firebase.auth().signOut(); };
    window.openModal = () => {};

    function createFavouriteCard(uid, favourite) {
      const card = document.createElement('article');
      card.className = 'favourite-item';

      const header = document.createElement('div');
      header.className = 'favourite-item__header';

      const eyebrow = document.createElement('span');
      eyebrow.className = 'favourite-item__eyebrow';
      eyebrow.textContent = inferFavouriteType(favourite);
      header.appendChild(eyebrow);

      const removeButton = document.createElement('button');
      removeButton.type = 'button';
      removeButton.className = 'favourite-item__remove';
      removeButton.textContent = 'Remove';
      removeButton.addEventListener('click', () => {
        removeFavourite(uid, favourite?.id);
        loadFavourites(uid);
      });
      header.appendChild(removeButton);

      const title = resolveFavouriteTitle(favourite);
      const titleEl = document.createElement('h3');
      titleEl.className = 'favourite-item__title';
      titleEl.textContent = title;

      const metaParts = buildFavouriteMeta(favourite, title);

      card.append(header, titleEl);

      if (metaParts.length) {
        const metaEl = document.createElement('p');
        metaEl.className = 'favourite-item__meta';
        metaEl.textContent = metaParts.join(' â€¢ ');
        card.appendChild(metaEl);
      }

      return card;
    }

    function loadFavourites(uid) {
      const grid = document.getElementById('favouritesGrid');
      grid.innerHTML = '';
      const favourites = Array.isArray(getFavourites(uid)) ? getFavourites(uid) : [];
      if (!favourites.length) {
        const emptyState = document.createElement('p');
        emptyState.className = 'dashboard-empty';
        emptyState.textContent = 'No favourites saved yet.';
        grid.appendChild(emptyState);
        return;
      }
      favourites.forEach((favourite) => {
        grid.appendChild(createFavouriteCard(uid, favourite));
      });
    }

    function loadRecents(uid) {
      const list = document.getElementById('recentsList');
      list.innerHTML = '';
      const recents = getRecents(uid);
      if (recents.length === 0) {
        list.innerHTML = '<li>No recent items.</li>';
        return;
      }
      recents.forEach(r => {
        const li = document.createElement('li');
        const a = document.createElement('a');
        a.href = r.url;
        a.textContent = r.title || r.url;
        li.appendChild(a);
        list.appendChild(li);
      });
    }

    function loadActivity(uid) {
      const list = document.getElementById('activityList');
      list.innerHTML = '';
      const acts = JSON.parse(localStorage.getItem(`activity_${uid}`) || '[]');
      if (acts.length === 0) {
        list.innerHTML = '<li>No recent activity.</li>';
        return;
      }
      acts.forEach(a => {
        const li = document.createElement('li');
        li.textContent = a;
        list.appendChild(li);
      });
    }

    firebase.auth().onAuthStateChanged(user => {
      const title = document.getElementById('welcomeTitle');
      const info = document.getElementById('profileInfo');
      const avatar = document.getElementById('profileAvatar');
      if (user) {
        title.textContent = `Welcome, ${user.email}`;
        avatar.src = user.photoURL || 'user-icon.png';
        info.textContent = '';
        loadFavourites(user.uid);
        loadActivity(user.uid);
        loadRecents(user.uid);
      } else {
        title.textContent = 'Welcome';
        avatar.src = 'user-icon.png';
        info.textContent = 'Please sign in to see your data.';
        document.getElementById('favouritesGrid').innerHTML = '<p>Sign in to manage favourites.</p>';
        document.getElementById('activityList').innerHTML = '<li>Sign in to see activity.</li>';
        loadRecents('guest');
      }
    });
  </script>
</body>
</html>
