<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard | RouteFlow London</title>
  <link rel="icon" href="images/New_Routflow_London_Logo.png" type="image/png" />
  <link href="https://fonts.googleapis.com/css2?family=Atkinson+Hyperlegible:wght@400;600&family=Inter:wght@400;600;800&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="dashboard.css" />
  <script src="theme.js" defer></script>
</head>
<body>
  <div id="navbar-container"></div>
  <main class="dashboard">
    <div class="dashboard-column">
      <section class="card profile-card">
        <img src="user-icon.png" alt="User Avatar" id="profileAvatar" />
        <div>
          <h2 id="welcomeTitle">Welcome</h2>
          <p id="profileInfo"></p>
        </div>
      </section>
      <section class="card" id="activityCard">
        <h2>Recent Activity</h2>
        <ul id="activityList" class="activity-list"></ul>
      </section>
    </div>
    <div class="dashboard-column">
      <section class="card">
        <h2>Your Favourites</h2>
        <div id="favouritesGrid" class="favourites-grid"></div>
      </section>
      <section class="card">
        <h2>Recents</h2>
        <ul id="recentsList" class="recents-list"></ul>
      </section>
    </div>
  </main>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDuedLuagA4IXc9ZMG9wvoak-sRrhtFZfo",
      authDomain: "routeflow-london.firebaseapp.com",
      projectId: "routeflow-london",
      storageBucket: "routeflow-london.firebasestorage.app",
      messagingSenderId: "368346241440",
      appId: "1:368346241440:web:7cc87d551420459251ecc5"
    };
    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
  </script>
  <script src="navbar-loader.js"></script>
  <script type="module">
    import {getFavourites, removeFavourite} from './favourites.js';
    import {getRecents} from './recents.js';

    window.signOut = () => { firebase.auth().signOut(); };
    window.openModal = () => {};

    function loadFavourites(uid) {
      const grid = document.getElementById('favouritesGrid');
      grid.innerHTML = '';
      const favs = getFavourites(uid);
      if (favs.length === 0) {
        grid.innerHTML = '<p>No favourites yet.</p>';
        return;
      }
      favs.forEach(f => {
        const div = document.createElement('div');
        div.className = 'favourite-item';
        div.innerHTML = `<h3>${f.type}</h3><p>${f.value}</p>`;
        const btn = document.createElement('button');
        btn.textContent = 'Remove';
        btn.addEventListener('click', () => {
          removeFavourite(uid, f.id);
          loadFavourites(uid);
        });
        div.appendChild(btn);
        grid.appendChild(div);
      });
    }

    function loadRecents(uid) {
      const list = document.getElementById('recentsList');
      list.innerHTML = '';
      const recents = getRecents(uid);
      if (recents.length === 0) {
        list.innerHTML = '<li>No recent items.</li>';
        return;
      }
      recents.forEach(r => {
        const li = document.createElement('li');
        const a = document.createElement('a');
        a.href = r.url;
        a.textContent = r.title || r.url;
        li.appendChild(a);
        list.appendChild(li);
      });
    }

    function loadActivity(uid) {
      const list = document.getElementById('activityList');
      list.innerHTML = '';
      const acts = JSON.parse(localStorage.getItem(`activity_${uid}`) || '[]');
      if (acts.length === 0) {
        list.innerHTML = '<li>No recent activity.</li>';
        return;
      }
      acts.forEach(a => {
        const li = document.createElement('li');
        li.textContent = a;
        list.appendChild(li);
      });
    }

    firebase.auth().onAuthStateChanged(user => {
      const title = document.getElementById('welcomeTitle');
      const info = document.getElementById('profileInfo');
      const avatar = document.getElementById('profileAvatar');
      if (user) {
        title.textContent = `Welcome, ${user.email}`;
        avatar.src = user.photoURL || 'user-icon.png';
        info.textContent = '';
        loadFavourites(user.uid);
        loadActivity(user.uid);
        loadRecents(user.uid);
      } else {
        title.textContent = 'Welcome';
        avatar.src = 'user-icon.png';
        info.textContent = 'Please sign in to see your data.';
        document.getElementById('favouritesGrid').innerHTML = '<p>Sign in to manage favourites.</p>';
        document.getElementById('activityList').innerHTML = '<li>Sign in to see activity.</li>';
        loadRecents('guest');
      }
    });
  </script>
</body>
</html>
