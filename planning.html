<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Journey Planning | Routeflow London</title>
  <link rel="icon" href="images/New_Routflow_London_Logo.png" type="image/png">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="style.css">
</head>
  <body>

   <header class="navbar">
  <div class="navbar__container">
    <a href="index.html" class="navbar__logo" aria-label="RouteFlow London Home">
      <img src="images/Routeflow London permanent logo.png" alt="RouteFlow London Logo" />
      <strong>RouteFlow London</strong>
    </a>
    <nav class="navbar__links" id="navbarLinks">
      <a href="index.html">Home</a>
      <a href="dashboard.html">Dashboard</a>
      <a href="tracking.html">Tracking</a>
      <a href="planning.html">Planning</a>
      <a href="routes.html">Routes</a>
      <a href="withdrawn.html">Withdrawn</a>
      <a href="disruptions.html">Disruptions</a>
      <a href="fleet.html">Fleet</a>
    </nav>
    <div class="navbar__controls">
      <button class="hamburger" id="hamburgerBtn" aria-label="Open mobile menu">
        <i class="fa-solid fa-bars"></i>
      </button>
      <div class="account-menu" id="accountMenu">
        <button aria-label="Account" id="profileIcon" type="button">
          <i class="fa-regular fa-user"></i>
        </button>
        <div class="account-dropdown" id="dropdownContent">
          <a href="profile.html">Profile</a>
          <a href="settings.html">Settings</a>
          <button onclick="openModal('login')" type="button">Login</button>
          <button onclick="openModal('signup')" type="button">Sign Up</button>
          <button onclick="signOut()" type="button">Sign out</button>
        </div>
      </div>
    </div>
  </div>
  <!-- Mobile nav drawer -->
  <nav class="mobile-drawer" id="mobileDrawer" aria-label="Mobile Navigation">
    <button class="close-drawer" id="closeDrawerBtn" aria-label="Close menu">
      <i class="fa-solid fa-times"></i>
    </button>
    <a href="index.html">Home</a>
    <a href="dashboard.html">Dashboard</a>
    <a href="tracking.html">Tracking</a>
    <a href="planning.html">Planning</a>
    <a href="routes.html">Routes</a>
    <a href="withdrawn.html">Withdrawn</a>
    <a href="disruptions.html">Disruptions</a>
    <a href="fleet.html">Fleet</a>
    <hr>
    <a href="profile.html">Profile</a>
    <a href="settings.html">Settings</a>
    <button onclick="openModal('login')" type="button">Login</button>
    <button onclick="openModal('signup')" type="button">Sign Up</button>
    <button onclick="signOut()" type="button">Sign out</button>
  </nav>
  <div class="drawer-backdrop" id="drawerBackdrop"></div>

  <!-- Modal for login/signup/reset -->
  <div id="authModal" class="modal" aria-modal="true" role="dialog">
    <div class="modal-content">
      <span class="close" id="closeModal" title="Close">&times;</span>
      <!-- Login Form -->
      <div id="loginFormContainer">
        <h2>Login</h2>
        <form id="loginForm" autocomplete="off">
          <input type="email" id="loginEmail" placeholder="Email" required autocomplete="username">
          <input type="password" id="loginPassword" placeholder="Password" required autocomplete="current-password">
          <button type="submit">Login</button>
          <button type="button" class="google-btn">Sign in with Google</button>
          <p><a href="#" class="reset-password" id="showReset">Forgot Password?</a></p>
          <div class="error-message" id="loginError" style="display:none;"></div>
        </form>
        <p>Don't have an account? <a href="#" id="showSignup">Sign up</a></p>
      </div>
      <!-- Signup Form -->
      <div id="signupFormContainer" style="display:none;">
        <h2>Sign Up</h2>
        <form id="signupForm" autocomplete="off">
          <input type="email" id="signupEmail" placeholder="Email" required autocomplete="username">
          <input type="password" id="signupPassword" placeholder="Password" required autocomplete="new-password">
          <button type="submit">Sign Up</button>
          <button type="button" class="google-btn">Sign Up with Google</button>
          <div class="error-message" id="signupError" style="display:none;"></div>
        </form>
        <p>Already have an account? <a href="#" id="showLogin">Login</a></p>
      </div>
      <!-- Reset Password Form -->
      <div id="resetFormContainer" style="display:none;">
        <h2>Reset Password</h2>
        <form id="resetForm" autocomplete="off">
          <input type="email" id="resetEmail" placeholder="Enter your email" required autocomplete="username">
          <button type="submit">Send Reset Link</button>
          <div class="error-message" id="resetError" style="display:none;"></div>
        </form>
        <p>Remembered? <a href="#" id="showLoginFromReset">Back to Login</a></p>
      </div>
    </div>
  </div>
</header>

<style>
.navbar {
  background: #fff;
  border-bottom: 1px solid #e5e5e5;
  position: sticky;
  top: 0;
  z-index: 1000;
  font-family: 'Segoe UI', Arial, sans-serif;
}

.navbar__container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 0.7rem 2vw;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 1.2rem;
}

.navbar__logo {
  display: flex;
  align-items: center;
  gap: 0.6rem;
  text-decoration: none;
  color: #c62828;
}
.navbar__logo img {
  height: 38px;
}
.navbar__logo strong {
  font-size: 1.25rem;
  font-weight: bold;
  letter-spacing: 1px;
}

/* Desktop nav links */
.navbar__links {
  display: flex;
  gap: 1rem;
}
.navbar__links a {
  color: #333;
  text-decoration: none;
  padding: 0.45rem 0.9rem;
  border-radius: 6px;
  font-weight: 500;
  font-size: 1.05rem;
  transition: background .18s, color .18s;
}
.navbar__links a.active,
.navbar__links a:hover {
  background: #2979ff;
  color: #fff;
}

.navbar__controls {
  display: flex;
  align-items: center;
  gap: 0.4rem;
}

/* Hamburger button */
.hamburger {
  background: none;
  border: none;
  font-size: 1.55rem;
  color: #c62828;
  cursor: pointer;
  display: none;
}
.account-menu {
  position: relative;
}
.account-menu button {
  background: none;
  border: none;
  font-size: 1.5rem;
  color: #333;
  padding: 0.15rem 0.4rem;
  border-radius: 50%;
  cursor: pointer;
  transition: background 0.17s;
}
.account-menu button:hover {
  background: #f0f0f0;
}
.account-dropdown {
  display: none;
  flex-direction: column;
  position: absolute;
  right: 0;
  top: 125%;
  background: #fff;
  border-radius: 8px;
  box-shadow: 0 4px 18px #0002;
  min-width: 150px;
  z-index: 10;
  padding: 0.5rem 0;
}
.account-dropdown a,
.account-dropdown button {
  background: none;
  border: none;
  color: #333;
  padding: 0.7rem 1rem;
  text-align: left;
  text-decoration: none;
  font-size: 1rem;
  font-weight: 500;
  cursor: pointer;
  transition: background 0.16s;
}
.account-dropdown a:hover,
.account-dropdown button:hover {
  background: #2979ff;
  color: #fff;
}
.account-menu.open .account-dropdown {
  display: flex;
}

/* Mobile Nav Drawer */
.mobile-drawer {
  display: flex;
  flex-direction: column;
  position: fixed;
  top: 0; left: 0;
  width: 80vw;
  max-width: 340px;
  height: 100vh;
  background: #fff;
  box-shadow: 2px 0 32px #0005;
  padding: 2rem 1.1rem 1.1rem 1.1rem;
  z-index: 1200;
  transform: translateX(-100%);
  transition: transform 0.3s cubic-bezier(.7,.3,.3,1);
  gap: 0.7rem;
  overflow-y: auto;
}
.mobile-drawer.open {
  transform: translateX(0);
}
.mobile-drawer a,
.mobile-drawer button {
  color: #333;
  text-decoration: none;
  padding: 0.75rem 0.7rem;
  border-radius: 6px;
  font-weight: 500;
  background: none;
  border: none;
  text-align: left;
  font-size: 1.08rem;
  transition: background .18s;
  cursor: pointer;
}
.mobile-drawer a:hover,
.mobile-drawer button:hover {
  background: #2979ff;
  color: #fff;
}
.mobile-drawer hr {
  margin: 1rem 0;
  border: none;
  border-top: 1px solid #eee;
}
.close-drawer {
  align-self: flex-end;
  margin-bottom: 1.2rem;
  color: #c62828;
  font-size: 1.3rem;
  background: none;
  border: none;
  cursor: pointer;
}

/* Drawer backdrop */
.drawer-backdrop {
  display: none;
  position: fixed;
  top: 0; left: 0;
  width: 100vw; height: 100vh;
  background: rgba(30,30,30,0.28);
  z-index: 1100;
  transition: opacity 0.2s;
}
.drawer-backdrop.open {
  display: block;
  opacity: 1;
}

/* Responsive */
@media (max-width: 950px) {
  .navbar__links {
    display: none;
  }
  .hamburger {
    display: block;
  }
}

/* Hide mobile drawer on desktop */
@media (min-width: 951px) {
  .mobile-drawer, .drawer-backdrop { display: none !important; }
}
.modal {
  display: none;
  position: fixed;
  z-index: 2000;
  left: 0; top: 0;
  width: 100vw; height: 100vh;
  background: rgba(0,0,0,0.38);
}
.modal-content {
  background: #fff;
  margin: 7% auto;
  border-radius: 14px;
  width: 94%;
  max-width: 375px;
  padding: 2.2rem 1.7rem 1.2rem 1.7rem;
  position: relative;
  box-shadow: 0 8px 44px #2979ff22;
  color: #2d3a4a;
  display: flex;
  flex-direction: column;
  gap: 0.7rem;
}
.close {
  position: absolute;
  right: 1.1rem;
  top: 1.1rem;
  font-size: 2rem;
  color: #888;
  background: none;
  border: none;
  cursor: pointer;
  transition: color .18s;
}
.close:hover { color: #d32f2f; }
/* Form elements */
.modal-content input {
  width: 100%;
  margin: 0.5rem 0;
  border-radius: 8px;
  border: 1.5px solid #bbb;
  padding: 0.8rem;
  font-size: 1.07rem;
  background: #fff;
  color: #222;
  transition: border .17s;
}
.modal-content input:focus {
  outline: none;
  border: 2px solid #2979ff;
}
.modal-content button[type="submit"], .google-btn {
  width: 100%;
  margin: 0.7rem 0 0.2rem 0;
  background: #2979ff;
  color: #fff;
  border: none;
  border-radius: 8px;
  padding: 0.8rem 0;
  font-size: 1.08rem;
  font-weight: 600;
  cursor: pointer;
  transition: background .18s;
}
.modal-content button[type="submit"]:hover, .google-btn:hover {
  background: #1565c0;
}
.google-btn {
  background: #4285F4;
  margin-bottom: 0.5rem;
}
.google-btn:hover {
  background: #357ae8;
}
.error-message {
  color: #d32f2f;
  font-size: 0.98rem;
  text-align: left;
  margin-top: 0.4rem;
}
.reset-password {
  color: #2979ff;
  text-decoration: underline;
  cursor: pointer;
  font-size: 0.98rem;
  transition: color .18s;
}
.reset-password:hover { color: #d32f2f; }
</style>

<script>
/* Account dropdown */
document.getElementById('profileIcon').addEventListener('click', function(e) {
  e.stopPropagation();
  const menu = document.getElementById('accountMenu');
  menu.classList.toggle('open');
});
document.addEventListener('click', function(e) {
  document.getElementById('accountMenu').classList.remove('open');
});

/* Mobile drawer open/close */
const hamburger = document.getElementById('hamburgerBtn');
const drawer = document.getElementById('mobileDrawer');
const backdrop = document.getElementById('drawerBackdrop');
const closeBtn = document.getElementById('closeDrawerBtn');
function openDrawer() {
  drawer.classList.add('open');
  backdrop.classList.add('open');
  document.body.style.overflow = 'hidden';
}
function closeDrawer() {
  drawer.classList.remove('open');
  backdrop.classList.remove('open');
  document.body.style.overflow = '';
}
hamburger.addEventListener('click', function(e) {
  e.stopPropagation(); openDrawer();
});
closeBtn.addEventListener('click', closeDrawer);
backdrop.addEventListener('click', closeDrawer);

/* Highlight active nav link */
const setActiveLink = (selector) => {
  const links = document.querySelectorAll(selector);
  const path = window.location.pathname.split('/').pop();
  links.forEach(link => {
    if (link.getAttribute('href') === path) {
      link.classList.add('active');
    }
  });
};
setActiveLink('.navbar__links a');
setActiveLink('.mobile-drawer a');

/* Modal logic */
function clearFormMessages() {
  document.getElementById('loginError').style.display = 'none';
  document.getElementById('signupError').style.display = 'none';
  document.getElementById('resetError').style.display = 'none';
}
function openModal(mode) {
  document.getElementById('authModal').style.display = 'block';
  document.getElementById('loginFormContainer').style.display = (mode==='login') ? '' : 'none';
  document.getElementById('signupFormContainer').style.display = (mode==='signup') ? '' : 'none';
  document.getElementById('resetFormContainer').style.display = 'none';
  clearFormMessages();
}
function closeModal() {
  document.getElementById('authModal').style.display = 'none';
  clearFormMessages();
}
document.getElementById('closeModal').onclick = closeModal;
window.onclick = function(event) {
  if (event.target === document.getElementById('authModal')) closeModal();
};
document.addEventListener('keydown', function(event) {
  if (event.key === "Escape") closeModal();
});

/* Switch between forms */
document.getElementById('showSignup').onclick = function(e) {
  e.preventDefault(); openModal('signup');
};
document.getElementById('showLogin').onclick = function(e) {
  e.preventDefault(); openModal('login');
};
document.getElementById('showLoginFromReset').onclick = function(e) {
  e.preventDefault(); openModal('login');
};
document.getElementById('showReset').onclick = function(e) {
  e.preventDefault();
  document.getElementById('loginFormContainer').style.display = 'none';
  document.getElementById('signupFormContainer').style.display = 'none';
  document.getElementById('resetFormContainer').style.display = '';
  clearFormMessages();
};

/* Dummy handlers for forms (replace with your own backend/auth logic) */
document.getElementById('loginForm').onsubmit = function(e) {
  e.preventDefault();
  // Replace with actual login logic
  closeModal();
  alert('Logged in (demo)');
};
document.getElementById('signupForm').onsubmit = function(e) {
  e.preventDefault();
  // Replace with actual signup logic
  closeModal();
  alert('Signed up (demo)');
};
document.getElementById('resetForm').onsubmit = function(e) {
  e.preventDefault();
  // Replace with actual reset logic
  closeModal();
  alert('Password reset link sent (demo)');
};
document.querySelectorAll('.google-btn').forEach(btn => {
  btn.onclick = function(e) {
    e.preventDefault();
    closeModal();
    alert('Google sign-in (demo)');
  };
});

/* Dummy sign out */
function signOut() {
  closeModal();
  alert('Signed out (demo)');
}
</script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    </div>
  </div>
</div>

<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>RouteFlow London — Journey Planner (Autocomplete + Disruptions + Fares)</title>

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>

<style>
  :root{
    --bg: #0f1720;
    --card: #0b1220;
    --accent: #e11d48;
    --muted: #9aa4b2;
    --glass: rgba(255,255,255,0.03);
    --radius: 12px;
    font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    color-scheme: dark;
  }
  html,body { height:100%; margin:0; background:linear-gradient(180deg,#071015 0%, #0f1720 100%); color:#e6eef6; }
  .app { display: grid; grid-template-columns: 400px 1fr; gap:18px; height:100vh; padding:18px; box-sizing:border-box; }
  .panel { background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border-radius: var(--radius); padding:16px; box-shadow: 0 6px 20px rgba(0,0,0,0.6); overflow:auto; }
  h1{ margin:0 0 8px 0; font-size:18px; display:flex; gap:8px; align-items:center;}
  .brand-dot{ width:10px;height:10px;border-radius:50%;background:var(--accent); box-shadow:0 0 12px rgba(225,29,72,0.35);} 
  label{ font-size:12px; color:var(--muted); margin-bottom:6px; display:block;}
  input[type="text"], input[type="date"], input[type="time"], select { width:100%; padding:10px 12px; border-radius:10px; border:1px solid rgba(255,255,255,0.04); background:var(--glass); color:inherit; font-size:14px; outline:none; }
  .modes { display:flex; gap:8px; flex-wrap:wrap; margin-top:8px;}
  .mode { padding:6px 8px; border-radius:8px; background:rgba(255,255,255,0.02); font-size:13px; cursor:pointer; border:1px solid rgba(255,255,255,0.02);} .mode.active{ background: linear-gradient(90deg, rgba(225,29,72,0.15), rgba(225,29,72,0.06)); border-color: rgba(225,29,72,0.25); box-shadow:0 4px 10px rgba(225,29,72,0.06); color:var(--accent);} 
  button.primary { appearance:none; border:0; padding:10px 14px; border-radius:10px; cursor:pointer; background: linear-gradient(90deg,var(--accent),#ff6b8a); color:white; font-weight:600; font-size:15px; width:100%; margin-top:10px; box-shadow: 0 8px 25px rgba(225,29,72,0.18); }
  .small { font-size:12px; color:var(--muted); margin-top:6px; }
  .map-wrap{ position:relative; border-radius:var(--radius); overflow:hidden; }
  #map { height:100%; min-height:280px; width:100%; display:block; }
  .results { padding:12px; display:flex; flex-direction:column; gap:12px; max-height:45vh; overflow:auto; }
  .journey-card { background:rgba(255,255,255,0.02); padding:10px; border-radius:10px; border:1px solid rgba(255,255,255,0.02); }
  .journey-meta{ display:flex; justify-content:space-between; align-items:center; gap:8px; }
  .leg{ font-size:13px; color:var(--muted); margin-top:6px; padding-left:8px; }
  .leg .title{ color:#e6eef6; font-weight:600; font-size:14px; }
  .loading { padding:8px; border-radius:8px; background:rgba(255,255,255,0.015); color:var(--muted); text-align:center; }

  /* autocomplete suggestions */
  .suggestions { position:relative; }
  .dropdown { position:absolute; left:0; right:0; top:100%; z-index:60; background:var(--card); border-radius:8px; margin-top:6px; max-height:240px; overflow:auto; border:1px solid rgba(255,255,255,0.04); }
  .item { padding:8px 10px; cursor:pointer; font-size:14px; color:var(--muted); }
  .item:hover { background:rgba(255,255,255,0.02); color:#e6eef6; }

  .status { margin-top:10px; font-size:13px; color:var(--muted); }
  .disruption { padding:8px; background:rgba(255,255,255,0.02); border-radius:8px; margin-top:6px; }

  @media (max-width:900px){ .app{ grid-template-columns: 1fr; grid-auto-rows: auto 1fr; padding:12px; gap:12px; } .panel{ order:1; } .map-wrap{ order:2; min-height:50vh; } }
</style>
</head>
<body>
  <div class="app" role="application" aria-label="RouteFlow London Journey Planner">
    <aside class="panel" aria-labelledby="planner-title">
      <h1 id="planner-title"><span class="brand-dot" aria-hidden="true"></span> RouteFlow London — Planner</h1>

      <div>
        <label for="from">From</label>
        <div class="suggestions">
          <input id="from" type="text" placeholder="Start — station, postcode or place" aria-label="From" autocomplete="off" />
          <div id="fromList" class="dropdown" hidden></div>
        </div>
      </div>

      <div style="margin-top:8px;">
        <label for="to">To</label>
        <div class="suggestions">
          <input id="to" type="text" placeholder="Destination — station, postcode or place" aria-label="To" autocomplete="off" />
          <div id="toList" class="dropdown" hidden></div>
        </div>
      </div>

      <div class="form-row" style="margin-top:10px; display:flex; gap:10px;">
        <div style="flex:1">
          <label for="date">Date</label>
          <input id="date" type="date" />
        </div>
        <div style="width:120px;">
          <label for="time">Time</label>
          <input id="time" type="time" />
        </div>
      </div>

      <div class="form-row" style="align-items:center;margin-top:6px;">
        <label style="margin:0 8px 0 0; font-size:13px; color:var(--muted);">Time is</label>
        <select id="timeIs" title="Departing or Arriving">
          <option value="Departing">Departing</option>
          <option value="Arriving">Arriving</option>
        </select>
      </div>

      <div style="margin-top:10px;">
        <label>Modes</label>
        <div class="modes" id="modes">
          <button class="mode active" data-mode="tube">Tube</button>
          <button class="mode active" data-mode="bus">Bus</button>
          <button class="mode active" data-mode="overground">Overground</button>
          <button class="mode active" data-mode="dlr">DLR</button>
          <button class="mode active" data-mode="tram">Tram</button>
          <button class="mode active" data-mode="river">River</button>
        </div>
      </div>

      <button class="primary" id="planBtn" aria-label="Plan journey">Plan Journey</button>
      <div class="small">Tip: For production, configure an API proxy to keep TfL keys secure. This widget expects a proxy at <code>/api/tfl</code> that forwards to <code>https://api.tfl.gov.uk</code>.</div>

      <div id="statusBox" class="status"></div>
      <div id="resultsContainer" class="results" aria-live="polite" style="margin-top:12px;"></div>
    </aside>

    <main class="map-wrap" aria-hidden="false">
      <div id="map"></div>
    </main>
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

<script>
/*
  Extended RouteFlow journey planner
  - Autocomplete (StopPoint Search) with debounce
  - Disruption/line status fetch
  - Fares display (from journey response if present)
  - Colour-coded legs using Tube/Line colours
  - Uses API_PROXY (recommended) to avoid exposing TfL keys client-side
*/

const API_PROXY = '/api/tfl'; // Keep TfL keys server-side via proxy
const CLIENT_APP_ID = '';
const CLIENT_APP_KEY = ''; // only for local dev if API_PROXY is empty

// Minimal mapping of TfL line ids to official colours (hex). Add more if needed.
const LINE_COLOURS = {
  bakerloo: '#B36305', bakerloo_text: '#fff',
  central: '#E32017', central_text: '#fff',
  circle: '#FFD300', circle_text: '#000',
  district: '#00782A', district_text: '#fff',
  northern: '#000000', northern_text: '#fff',
  piccadilly: '#0019A8', piccadilly_text: '#fff',
  victoria: '#00A0E2', victoria_text: '#fff',
  jubilee: '#6A7278', jubilee_text: '#fff',
  metropolitan: '#9B0056', metropolitan_text: '#fff',
  hammersmithcity: '#F3A9BB', hammersmithcity_text: '#000',
  overground: '#EE7C0E', overground_text: '#fff',
  dlr: '#00A4A7', dlr_text: '#fff',
  tram: '#84B51A', tram_text: '#000',
  river: '#00ADEF', river_text: '#fff',
  bus: '#D50A0A', bus_text: '#fff',
  walk: '#9aa4b2'
};

// Map init
const map = L.map('map', { zoomControl: true }).setView([51.5074, -0.1278], 12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap contributors' }).addTo(map);
let routeLayer = L.layerGroup().addTo(map);
let markersLayer = L.layerGroup().addTo(map);

// UI elements
const planBtn = document.getElementById('planBtn');
const fromInput = document.getElementById('from');
const toInput = document.getElementById('to');
const dateInput = document.getElementById('date');
const timeInput = document.getElementById('time');
const timeIsEl = document.getElementById('timeIs');
const resultsContainer = document.getElementById('resultsContainer');
const modesEl = document.getElementById('modes');
const fromList = document.getElementById('fromList');
const toList = document.getElementById('toList');
const statusBox = document.getElementById('statusBox');

(function setDefaultDateTime(){ const now = new Date(); dateInput.value = now.toISOString().slice(0,10); timeInput.value = now.toTimeString().slice(0,5); })();

function getSelectedModes(){ const active = Array.from(modesEl.querySelectorAll('.mode.active')); return active.map(btn => btn.dataset.mode).join(','); }
modesEl.addEventListener('click', (e)=>{ const btn = e.target.closest('.mode'); if(!btn) return; btn.classList.toggle('active'); });

// debounce helper for autocomplete
function debounce(fn, wait){ let t; return function(...args){ clearTimeout(t); t = setTimeout(()=> fn.apply(this,args), wait); }; }

// Build URL helper (similar to earlier)
function buildUrl(path, params = {}){
  const qs = new URLSearchParams(params);
  if (!API_PROXY && CLIENT_APP_ID && CLIENT_APP_KEY) { qs.set('app_id', CLIENT_APP_ID); qs.set('app_key', CLIENT_APP_KEY); return `https://api.tfl.gov.uk${path}?${qs.toString()}`; }
  return `${API_PROXY}${path}?${qs.toString()}`;
}

// Autocomplete: call StopPoint/Search/{query}
async function stopPointSearch(q){
  if (!q || q.length < 2) return [];
  try{
    const modes = getSelectedModes();
    const url = buildUrl(`/StopPoint/Search/${encodeURIComponent(q)}`, { modes: modes || '' });
    const res = await fetch(url);
    if (!res.ok) return [];
    const data = await res.json();
    // TfL StopPoint search returns matches in data.matches
    return data && data.matches ? data.matches : [];
  } catch(e){ console.error('stopPointSearch', e); return []; }
}

function showDropdown(listEl, items, onSelect){
  listEl.innerHTML = '';
  if (!items || items.length === 0){ listEl.hidden = true; return; }
  items.slice(0,8).forEach(it => {
    const div = document.createElement('div');
    div.className = 'item';
    // show commonName with indicator (stop type)
    div.innerHTML = `<strong style="color:var(--muted)">${it.name || it.commonName || it.icn || ''}</strong><div style="font-size:12px;color:var(--muted)">${it.placeType || it.modes ? (it.modes ? it.modes.join(', ') : '') : ''} ${it.id ? '' : ''}</div>`;
    div.addEventListener('click', ()=>{
      onSelect(it);
      listEl.hidden = true;
    });
    listEl.appendChild(div);
  });
  listEl.hidden = false;
}

const debouncedFrom = debounce(async ()=>{
  const q = fromInput.value.trim();
  if (!q) { fromList.hidden = true; return; }
  const matches = await stopPointSearch(q);
  showDropdown(fromList, matches, sel => {
    fromInput.value = sel.name || sel.commonName || sel.matchedName || q;
    fromInput.dataset.id = sel.id || '';
  });
}, 300);

const debouncedTo = debounce(async ()=>{
  const q = toInput.value.trim();
  if (!q) { toList.hidden = true; return; }
  const matches = await stopPointSearch(q);
  showDropdown(toList, matches, sel => {
    toInput.value = sel.name || sel.commonName || sel.matchedName || q;
    toInput.dataset.id = sel.id || '';
  });
}, 300);

fromInput.addEventListener('input', debouncedFrom);
toInput.addEventListener('input', debouncedTo);

// hide dropdown if clicked outside
window.addEventListener('click', (e)=>{ if (!e.target.closest('.suggestions')){ fromList.hidden = true; toList.hidden = true; } });

// fetch line statuses for selected modes (to show disruptions)
async function fetchLineStatus(modes){
  try{
    // modes can be csv. We'll call /Line/Mode/{modes}/Status
    const modePath = modes ? modes.split(',').map(m=>m.trim()).filter(Boolean).join(',') : 'tube,dlr,overground,tram';
    const url = buildUrl(`/Line/Mode/${encodeURIComponent(modePath)}/Status`, {});
    const res = await fetch(url);
    if (!res.ok) return null;
    return await res.json();
  } catch(e){ console.error('fetchLineStatus', e); return null; }
}

function displayLineStatuses(statuses){
  if (!statuses || statuses.length === 0){ statusBox.textContent = 'No current service disruptions detected.'; return; }
  // show top-level disruptions for lines with issues
  const issues = statuses.filter(l => l.lineStatuses && l.lineStatuses.some(s => s.statusSeverity !== 10));
  if (issues.length === 0){ statusBox.textContent = 'No current service disruptions detected.'; return; }
  statusBox.innerHTML = '';
  issues.forEach(line => {
    const d = document.createElement('div'); d.className = 'disruption';
    const colour = LINE_COLOURS[line.id] || LINE_COLOURS['walk'];
    d.innerHTML = `<strong style="color:${colour}">${line.name}</strong> — ${line.lineStatuses.map(s=>s.statusSeverityDescription).join(', ')}<div style="font-size:13px;color:var(--muted);margin-top:6px">${line.disruptions && line.disruptions.length ? line.disruptions.slice(0,2).map(dr=>dr.description).join(' — ') : ''}</div>`;
    statusBox.appendChild(d);
  });
}

function showLoading(){ resultsContainer.innerHTML = '<div class="loading">Planning journey…</div>'; routeLayer.clearLayers(); markersLayer.clearLayers(); }
function showError(msg){ resultsContainer.innerHTML = `<div class="loading" role="alert">Error: ${msg}</div>`; }

function getColourForLeg(leg){
  // prefer lineId or routeId if present
  const lineId = (leg.routeId || (leg.routeOptions && leg.routeOptions[0] && leg.routeOptions[0].id) || (leg.lineId || (leg.serviceId || ''))).toLowerCase();
  if (lineId && LINE_COLOURS[lineId]) return LINE_COLOURS[lineId];
  // else by mode
  const mode = (leg.mode && leg.mode.id) || (leg.modeName || '').toLowerCase();
  if (mode && LINE_COLOURS[mode]) return LINE_COLOURS[mode];
  return LINE_COLOURS['walk'];
}

function renderJourneys(data){
  routeLayer.clearLayers(); markersLayer.clearLayers(); resultsContainer.innerHTML = '';
  if (!data || !data.journeys || data.journeys.length === 0) { showError('No journeys found.'); return; }

  // show line statuses (get modes used)
  const usedModes = Array.from(new Set(data.journeys.flatMap(j => j.legs.map(l => (l.mode && l.mode.id) || (l.modeName||'').toLowerCase())))).filter(Boolean).join(',');
  fetchLineStatus(usedModes).then(displayLineStatuses).catch(()=>{});

  data.journeys.forEach((journey, jidx) => {
    const card = document.createElement('div'); card.className = 'journey-card';
    const header = document.createElement('div'); header.className = 'journey-meta';
    header.innerHTML = `<div><strong>Journey ${jidx+1}</strong> — ${journey.duration} mins</div><div style="text-align:right;color:var(--muted);font-size:13px;">${journey.legs.length} legs</div>`;
    card.appendChild(header);

    // fares (if present)
    if (journey.fare && journey.fare.totalCost) {
      const p = document.createElement('div'); p.style.marginTop='6px'; p.innerHTML = `<strong>Estimated fare:</strong> ${journey.fare.displayCost || (journey.fare.totalCost/100)+' GBP'}`; card.appendChild(p);
    } else if (journey.fare && journey.fare.totalCost === undefined && journey.fare.displayCost){
      const p = document.createElement('div'); p.style.marginTop='6px'; p.innerHTML = `<strong>Estimated fare:</strong> ${journey.fare.displayCost}`; card.appendChild(p);
    }

    // legs
    const allCoords = [];
    journey.legs.forEach((leg, lidx) => {
      const legEl = document.createElement('div'); legEl.className = 'leg';
      const modeName = (leg.mode && leg.mode.name) || (leg.modeName || 'Walk');
      const dep = leg.departurePoint ? leg.departurePoint.commonName : '';
      const arr = leg.arrivalPoint ? leg.arrivalPoint.commonName : '';
      const colour = getColourForLeg(leg) || '#9aa4b2';
      let title = `<div class="title">${modeName} — ${dep} → ${arr} (${leg.duration ? leg.duration+'m' : ''})</div>`;
      let instr = '';
      if (leg.instruction && leg.instruction.summary) instr = `<div>${leg.instruction.summary}</div>`;
      // disruptions for leg
      if (leg.disruption && leg.disruption.length){ instr += `<div style="color:#ffb4c4;font-size:12px">⚠ ${leg.disruption.map(d=>d.category).join(', ')}</div>`; }
      legEl.innerHTML = title + instr;
      card.appendChild(legEl);

      // map geometry
      if (leg.path && leg.path.lineString && leg.path.lineString.length > 0) {
        const coords = leg.path.lineString.map(p => [p.lat, p.lon]);
        allCoords.push(...coords);
        const poly = L.polyline(coords, { weight: 6, opacity: 0.95, color: colour }).addTo(routeLayer);
        // add simple markers at start/end of leg
        const start = coords[0]; const end = coords[coords.length-1];
        L.circleMarker(start, { radius:5, color:colour, fillOpacity:1 }).addTo(markersLayer);
        L.circleMarker(end, { radius:5, color:colour, fillOpacity:1 }).addTo(markersLayer);
      } else {
        // fallback: mark departure/arrival points if latlon provided
        if (leg.departurePoint && leg.departurePoint.lat && leg.departurePoint.lon){ const s = [leg.departurePoint.lat, leg.departurePoint.lon]; L.circleMarker(s,{radius:5,color:colour}).addTo(markersLayer); allCoords.push(s); }
        if (leg.arrivalPoint && leg.arrivalPoint.lat && leg.arrivalPoint.lon){ const e = [leg.arrivalPoint.lat, leg.arrivalPoint.lon]; L.circleMarker(e,{radius:5,color:colour}).addTo(markersLayer); allCoords.push(e); }
      }
    });

    // focus button
    const focusBtn = document.createElement('button'); focusBtn.textContent = 'Focus on map'; focusBtn.style.marginTop='8px'; focusBtn.className='primary'; focusBtn.style.width='auto';
    focusBtn.addEventListener('click', ()=>{ if (allCoords.length){ const bounds = L.latLngBounds(allCoords); map.fitBounds(bounds.pad(0.6)); } });
    card.appendChild(focusBtn);

    resultsContainer.appendChild(card);

    // auto-fit to first journey
    if (jidx === 0 && allCoords.length){ const b = L.latLngBounds(allCoords); map.fitBounds(b.pad(0.6)); }
  });
}

// perform the fetch of journeys
async function planJourney(){
  const from = fromInput.value.trim(); const to = toInput.value.trim();
  if (!from || !to) { showError('Please enter both origin and destination.'); return; }

  // prefer stoppoint id if selected (but TfL Journey API accepts place names too)
  const fromId = fromInput.dataset.id || '';
  const toId = toInput.dataset.id || '';
  const fromParam = fromId || from; const toParam = toId || to;

  const urlPath = `/Journey/JourneyResults/${encodeURIComponent(fromParam)}/to/${encodeURIComponent(toParam)}`;
  const url = buildUrl(urlPath, { timeIs: timeIsEl.value, date: dateInput.value, time: timeInput.value, mode: getSelectedModes() });

  showLoading();
  try{
    const res = await fetch(url);
    if (!res.ok){ const txt = await res.text(); showError(`TfL API returned ${res.status}: ${txt}`); return; }
    const data = await res.json(); renderJourneys(data);
  } catch(e){ console.error(e); showError('Network or CORS error. If running client-side, ensure TfL API allows your origin or use a server proxy.'); }
}

planBtn.addEventListener('click', planJourney);
[fromInput, toInput].forEach(el => { el.addEventListener('keydown', (e)=> { if (e.key === 'Enter') planJourney(); }); });

</script>
</body>
</html>
