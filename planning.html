<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Journey Planning | Routeflow London</title>
  <link rel="icon" href="images/New_Routflow_London_Logo.png" type="image/png">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="style.css">
</head>
  <body>

   <header class="navbar">
  <div class="navbar__container">
    <a href="index.html" class="navbar__logo" aria-label="RouteFlow London Home">
      <img src="images/Routeflow London permanent logo.png" alt="RouteFlow London Logo" />
      <strong>RouteFlow London</strong>
    </a>
    <nav class="navbar__links" id="navbarLinks">
      <a href="index.html">Home</a>
      <a href="dashboard.html">Dashboard</a>
      <a href="tracking.html">Tracking</a>
      <a href="planning.html">Planning</a>
      <a href="routes.html">Routes</a>
      <a href="withdrawn.html">Withdrawn</a>
      <a href="disruptions.html">Disruptions</a>
      <a href="fleet.html">Fleet</a>
    </nav>
    <div class="navbar__controls">
      <button class="hamburger" id="hamburgerBtn" aria-label="Open mobile menu">
        <i class="fa-solid fa-bars"></i>
      </button>
      <div class="account-menu" id="accountMenu">
        <button aria-label="Account" id="profileIcon" type="button">
          <i class="fa-regular fa-user"></i>
        </button>
        <div class="account-dropdown" id="dropdownContent">
          <a href="profile.html">Profile</a>
          <a href="settings.html">Settings</a>
          <button onclick="openModal('login')" type="button">Login</button>
          <button onclick="openModal('signup')" type="button">Sign Up</button>
          <button onclick="signOut()" type="button">Sign out</button>
        </div>
      </div>
    </div>
  </div>
  <!-- Mobile nav drawer -->
  <nav class="mobile-drawer" id="mobileDrawer" aria-label="Mobile Navigation">
    <button class="close-drawer" id="closeDrawerBtn" aria-label="Close menu">
      <i class="fa-solid fa-times"></i>
    </button>
    <a href="index.html">Home</a>
    <a href="dashboard.html">Dashboard</a>
    <a href="tracking.html">Tracking</a>
    <a href="planning.html">Planning</a>
    <a href="routes.html">Routes</a>
    <a href="withdrawn.html">Withdrawn</a>
    <a href="disruptions.html">Disruptions</a>
    <a href="fleet.html">Fleet</a>
    <hr>
    <a href="profile.html">Profile</a>
    <a href="settings.html">Settings</a>
    <button onclick="openModal('login')" type="button">Login</button>
    <button onclick="openModal('signup')" type="button">Sign Up</button>
    <button onclick="signOut()" type="button">Sign out</button>
  </nav>
  <div class="drawer-backdrop" id="drawerBackdrop"></div>

  <!-- Modal for login/signup/reset -->
  <div id="authModal" class="modal" aria-modal="true" role="dialog">
    <div class="modal-content">
      <span class="close" id="closeModal" title="Close">&times;</span>
      <!-- Login Form -->
      <div id="loginFormContainer">
        <h2>Login</h2>
        <form id="loginForm" autocomplete="off">
          <input type="email" id="loginEmail" placeholder="Email" required autocomplete="username">
          <input type="password" id="loginPassword" placeholder="Password" required autocomplete="current-password">
          <button type="submit">Login</button>
          <button type="button" class="google-btn">Sign in with Google</button>
          <p><a href="#" class="reset-password" id="showReset">Forgot Password?</a></p>
          <div class="error-message" id="loginError" style="display:none;"></div>
        </form>
        <p>Don't have an account? <a href="#" id="showSignup">Sign up</a></p>
      </div>
      <!-- Signup Form -->
      <div id="signupFormContainer" style="display:none;">
        <h2>Sign Up</h2>
        <form id="signupForm" autocomplete="off">
          <input type="email" id="signupEmail" placeholder="Email" required autocomplete="username">
          <input type="password" id="signupPassword" placeholder="Password" required autocomplete="new-password">
          <button type="submit">Sign Up</button>
          <button type="button" class="google-btn">Sign Up with Google</button>
          <div class="error-message" id="signupError" style="display:none;"></div>
        </form>
        <p>Already have an account? <a href="#" id="showLogin">Login</a></p>
      </div>
      <!-- Reset Password Form -->
      <div id="resetFormContainer" style="display:none;">
        <h2>Reset Password</h2>
        <form id="resetForm" autocomplete="off">
          <input type="email" id="resetEmail" placeholder="Enter your email" required autocomplete="username">
          <button type="submit">Send Reset Link</button>
          <div class="error-message" id="resetError" style="display:none;"></div>
        </form>
        <p>Remembered? <a href="#" id="showLoginFromReset">Back to Login</a></p>
      </div>
    </div>
  </div>
</header>

<style>
.navbar {
  background: #fff;
  border-bottom: 1px solid #e5e5e5;
  position: sticky;
  top: 0;
  z-index: 1000;
  font-family: 'Segoe UI', Arial, sans-serif;
}

.navbar__container {
  max-width: 1200px;
  margin: 0 auto;
  padding: 0.7rem 2vw;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 1.2rem;
}

.navbar__logo {
  display: flex;
  align-items: center;
  gap: 0.6rem;
  text-decoration: none;
  color: #c62828;
}
.navbar__logo img {
  height: 38px;
}
.navbar__logo strong {
  font-size: 1.25rem;
  font-weight: bold;
  letter-spacing: 1px;
}

/* Desktop nav links */
.navbar__links {
  display: flex;
  gap: 1rem;
}
.navbar__links a {
  color: #333;
  text-decoration: none;
  padding: 0.45rem 0.9rem;
  border-radius: 6px;
  font-weight: 500;
  font-size: 1.05rem;
  transition: background .18s, color .18s;
}
.navbar__links a.active,
.navbar__links a:hover {
  background: #2979ff;
  color: #fff;
}

.navbar__controls {
  display: flex;
  align-items: center;
  gap: 0.4rem;
}

/* Hamburger button */
.hamburger {
  background: none;
  border: none;
  font-size: 1.55rem;
  color: #c62828;
  cursor: pointer;
  display: none;
}
.account-menu {
  position: relative;
}
.account-menu button {
  background: none;
  border: none;
  font-size: 1.5rem;
  color: #333;
  padding: 0.15rem 0.4rem;
  border-radius: 50%;
  cursor: pointer;
  transition: background 0.17s;
}
.account-menu button:hover {
  background: #f0f0f0;
}
.account-dropdown {
  display: none;
  flex-direction: column;
  position: absolute;
  right: 0;
  top: 125%;
  background: #fff;
  border-radius: 8px;
  box-shadow: 0 4px 18px #0002;
  min-width: 150px;
  z-index: 10;
  padding: 0.5rem 0;
}
.account-dropdown a,
.account-dropdown button {
  background: none;
  border: none;
  color: #333;
  padding: 0.7rem 1rem;
  text-align: left;
  text-decoration: none;
  font-size: 1rem;
  font-weight: 500;
  cursor: pointer;
  transition: background 0.16s;
}
.account-dropdown a:hover,
.account-dropdown button:hover {
  background: #2979ff;
  color: #fff;
}
.account-menu.open .account-dropdown {
  display: flex;
}

/* Mobile Nav Drawer */
.mobile-drawer {
  display: flex;
  flex-direction: column;
  position: fixed;
  top: 0; left: 0;
  width: 80vw;
  max-width: 340px;
  height: 100vh;
  background: #fff;
  box-shadow: 2px 0 32px #0005;
  padding: 2rem 1.1rem 1.1rem 1.1rem;
  z-index: 1200;
  transform: translateX(-100%);
  transition: transform 0.3s cubic-bezier(.7,.3,.3,1);
  gap: 0.7rem;
  overflow-y: auto;
}
.mobile-drawer.open {
  transform: translateX(0);
}
.mobile-drawer a,
.mobile-drawer button {
  color: #333;
  text-decoration: none;
  padding: 0.75rem 0.7rem;
  border-radius: 6px;
  font-weight: 500;
  background: none;
  border: none;
  text-align: left;
  font-size: 1.08rem;
  transition: background .18s;
  cursor: pointer;
}
.mobile-drawer a:hover,
.mobile-drawer button:hover {
  background: #2979ff;
  color: #fff;
}
.mobile-drawer hr {
  margin: 1rem 0;
  border: none;
  border-top: 1px solid #eee;
}
.close-drawer {
  align-self: flex-end;
  margin-bottom: 1.2rem;
  color: #c62828;
  font-size: 1.3rem;
  background: none;
  border: none;
  cursor: pointer;
}

/* Drawer backdrop */
.drawer-backdrop {
  display: none;
  position: fixed;
  top: 0; left: 0;
  width: 100vw; height: 100vh;
  background: rgba(30,30,30,0.28);
  z-index: 1100;
  transition: opacity 0.2s;
}
.drawer-backdrop.open {
  display: block;
  opacity: 1;
}

/* Responsive */
@media (max-width: 950px) {
  .navbar__links {
    display: none;
  }
  .hamburger {
    display: block;
  }
}

/* Hide mobile drawer on desktop */
@media (min-width: 951px) {
  .mobile-drawer, .drawer-backdrop { display: none !important; }
}
.modal {
  display: none;
  position: fixed;
  z-index: 2000;
  left: 0; top: 0;
  width: 100vw; height: 100vh;
  background: rgba(0,0,0,0.38);
}
.modal-content {
  background: #fff;
  margin: 7% auto;
  border-radius: 14px;
  width: 94%;
  max-width: 375px;
  padding: 2.2rem 1.7rem 1.2rem 1.7rem;
  position: relative;
  box-shadow: 0 8px 44px #2979ff22;
  color: #2d3a4a;
  display: flex;
  flex-direction: column;
  gap: 0.7rem;
}
.close {
  position: absolute;
  right: 1.1rem;
  top: 1.1rem;
  font-size: 2rem;
  color: #888;
  background: none;
  border: none;
  cursor: pointer;
  transition: color .18s;
}
.close:hover { color: #d32f2f; }
/* Form elements */
.modal-content input {
  width: 100%;
  margin: 0.5rem 0;
  border-radius: 8px;
  border: 1.5px solid #bbb;
  padding: 0.8rem;
  font-size: 1.07rem;
  background: #fff;
  color: #222;
  transition: border .17s;
}
.modal-content input:focus {
  outline: none;
  border: 2px solid #2979ff;
}
.modal-content button[type="submit"], .google-btn {
  width: 100%;
  margin: 0.7rem 0 0.2rem 0;
  background: #2979ff;
  color: #fff;
  border: none;
  border-radius: 8px;
  padding: 0.8rem 0;
  font-size: 1.08rem;
  font-weight: 600;
  cursor: pointer;
  transition: background .18s;
}
.modal-content button[type="submit"]:hover, .google-btn:hover {
  background: #1565c0;
}
.google-btn {
  background: #4285F4;
  margin-bottom: 0.5rem;
}
.google-btn:hover {
  background: #357ae8;
}
.error-message {
  color: #d32f2f;
  font-size: 0.98rem;
  text-align: left;
  margin-top: 0.4rem;
}
.reset-password {
  color: #2979ff;
  text-decoration: underline;
  cursor: pointer;
  font-size: 0.98rem;
  transition: color .18s;
}
.reset-password:hover { color: #d32f2f; }
</style>

<script>
/* Account dropdown */
document.getElementById('profileIcon').addEventListener('click', function(e) {
  e.stopPropagation();
  const menu = document.getElementById('accountMenu');
  menu.classList.toggle('open');
});
document.addEventListener('click', function(e) {
  document.getElementById('accountMenu').classList.remove('open');
});

/* Mobile drawer open/close */
const hamburger = document.getElementById('hamburgerBtn');
const drawer = document.getElementById('mobileDrawer');
const backdrop = document.getElementById('drawerBackdrop');
const closeBtn = document.getElementById('closeDrawerBtn');
function openDrawer() {
  drawer.classList.add('open');
  backdrop.classList.add('open');
  document.body.style.overflow = 'hidden';
}
function closeDrawer() {
  drawer.classList.remove('open');
  backdrop.classList.remove('open');
  document.body.style.overflow = '';
}
hamburger.addEventListener('click', function(e) {
  e.stopPropagation(); openDrawer();
});
closeBtn.addEventListener('click', closeDrawer);
backdrop.addEventListener('click', closeDrawer);

/* Highlight active nav link */
const setActiveLink = (selector) => {
  const links = document.querySelectorAll(selector);
  const path = window.location.pathname.split('/').pop();
  links.forEach(link => {
    if (link.getAttribute('href') === path) {
      link.classList.add('active');
    }
  });
};
setActiveLink('.navbar__links a');
setActiveLink('.mobile-drawer a');

/* Modal logic */
function clearFormMessages() {
  document.getElementById('loginError').style.display = 'none';
  document.getElementById('signupError').style.display = 'none';
  document.getElementById('resetError').style.display = 'none';
}
function openModal(mode) {
  document.getElementById('authModal').style.display = 'block';
  document.getElementById('loginFormContainer').style.display = (mode==='login') ? '' : 'none';
  document.getElementById('signupFormContainer').style.display = (mode==='signup') ? '' : 'none';
  document.getElementById('resetFormContainer').style.display = 'none';
  clearFormMessages();
}
function closeModal() {
  document.getElementById('authModal').style.display = 'none';
  clearFormMessages();
}
document.getElementById('closeModal').onclick = closeModal;
window.onclick = function(event) {
  if (event.target === document.getElementById('authModal')) closeModal();
};
document.addEventListener('keydown', function(event) {
  if (event.key === "Escape") closeModal();
});

/* Switch between forms */
document.getElementById('showSignup').onclick = function(e) {
  e.preventDefault(); openModal('signup');
};
document.getElementById('showLogin').onclick = function(e) {
  e.preventDefault(); openModal('login');
};
document.getElementById('showLoginFromReset').onclick = function(e) {
  e.preventDefault(); openModal('login');
};
document.getElementById('showReset').onclick = function(e) {
  e.preventDefault();
  document.getElementById('loginFormContainer').style.display = 'none';
  document.getElementById('signupFormContainer').style.display = 'none';
  document.getElementById('resetFormContainer').style.display = '';
  clearFormMessages();
};

/* Dummy handlers for forms (replace with your own backend/auth logic) */
document.getElementById('loginForm').onsubmit = function(e) {
  e.preventDefault();
  // Replace with actual login logic
  closeModal();
  alert('Logged in (demo)');
};
document.getElementById('signupForm').onsubmit = function(e) {
  e.preventDefault();
  // Replace with actual signup logic
  closeModal();
  alert('Signed up (demo)');
};
document.getElementById('resetForm').onsubmit = function(e) {
  e.preventDefault();
  // Replace with actual reset logic
  closeModal();
  alert('Password reset link sent (demo)');
};
document.querySelectorAll('.google-btn').forEach(btn => {
  btn.onclick = function(e) {
    e.preventDefault();
    closeModal();
    alert('Google sign-in (demo)');
  };
});

/* Dummy sign out */
function signOut() {
  closeModal();
  alert('Signed out (demo)');
}
</script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    </div>
  </div>
</div>

<title>RouteFlow London — Upgraded Journey Planner</title>
<style>
:root{
  --brand:#e11d48; --bg:#ffffff; --card:#fff; --muted:#6b7280; --ink:#111827;
  --border:#e6e8eb; --radius:12px;
}
*{box-sizing:border-box}
body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:var(--ink)}
.container{max-width:1200px;margin:18px auto;padding:18px}
.header{display:flex;align-items:center;gap:12px;margin-bottom:12px}
.logo-dot{width:12px;height:12px;border-radius:50%;background:var(--brand)}
.grid{display:grid;grid-template-columns:380px 1fr;gap:18px}
@media (max-width:980px){.grid{grid-template-columns:1fr}}
.panel{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px}
label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
.input, select{width:100%;padding:10px;border:1px solid var(--border);border-radius:10px;background:#fff;font-size:14px}
.row{display:flex;gap:8px;align-items:center}
.modes{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
.chip{padding:6px 10px;border-radius:999px;border:1px solid var(--border);background:#fff;cursor:pointer;font-size:13px}
.chip.active{border-color:var(--brand);color:var(--brand)}
.btn{padding:10px 12px;border-radius:10px;border:0;background:var(--brand);color:#fff;font-weight:600;cursor:pointer}
.small{font-size:12px;color:var(--muted)}
.results{margin-top:12px;display:flex;flex-direction:column;gap:12px;max-height:65vh;overflow:auto;padding-right:6px}
.card{border:1px solid var(--border);border-radius:10px;padding:10px;background:#fff}
.summary{display:flex;justify-content:space-between;align-items:center;gap:12px}
.summary-left{display:flex;gap:10px;align-items:center}
.summary-text{display:flex;flex-direction:column}
.summary-title{font-weight:700}
.mode-icons{display:flex;gap:6px;flex-wrap:wrap}
.mode-icon{display:inline-flex;align-items:center;justify-content:center;border-radius:8px;padding:4px 6px;font-size:12px;border:1px solid var(--border)}
.spark{width:160px;height:48px;border-radius:8px;border:1px solid var(--border);display:block}
.loading{padding:10px;border-radius:8px;background:#fff;border:1px dashed var(--border);text-align:center;color:var(--muted)}
.error{padding:10px;border-radius:8px;background:#fff;border:1px dashed #f8d7da;color:#842029}
.sugg{position:relative}
.dd{position:absolute;left:0;right:0;top:100%;z-index:90;background:#fff;border:1px solid var(--border);border-radius:10px;margin-top:6px;max-height:230px;overflow:auto}
.dd-item{padding:8px 10px;cursor:pointer}
.dd-item:hover{background:#f8f9fb}
.kbd{font-family:ui-monospace,monospace;background:#f3f4f6;padding:2px 6px;border-radius:6px;border:1px solid var(--border);font-size:12px}

/* modal */
.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.35);z-index:120}
.modal.open{display:flex}
.sheet{width:min(920px,98%);max-height:88vh;background:#fff;border-radius:12px;overflow:auto;border:1px solid var(--border)}
.sheet header{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--border);padding:12px 14px;display:flex;justify-content:space-between;align-items:center;gap:8px}
.sheet .content{padding:14px}
.leg{border-radius:8px;padding:10px;border:1px solid var(--border);margin-bottom:10px}
.leg h4{margin:0 0 6px 0;display:flex;gap:8px;align-items:center}
.stops{padding-left:18px;margin:6px 0 0 0}
.stops li{margin:2px 0}
.footer-note{font-size:12px;color:var(--muted);margin-top:8px}
.share-row{display:flex;gap:8px}
</style>
</head>
<body>

<div class="container">
  <div class="header">
    <div class="logo-dot" aria-hidden="true"></div>
    <h2 style="margin:0">RouteFlow London — Journey Planner</h2>
  </div>

  <div class="grid">
    <aside class="panel" aria-labelledby="planner-title">
      <div id="planner-title" style="font-weight:700;margin-bottom:8px">Plan a journey</div>

      <div class="sugg" style="margin-bottom:10px">
        <label for="from">From</label>
        <input id="from" class="input" type="text" placeholder="Type origin (e.g. King's Cross)" aria-label="From">
        <div id="fromDD" class="dd" hidden></div>
      </div>

      <div class="sugg" style="margin-bottom:10px">
        <label for="to">To</label>
        <input id="to" class="input" type="text" placeholder="Type destination (e.g. Waterloo)" aria-label="To">
        <div id="toDD" class="dd" hidden></div>
      </div>

      <div style="display:flex;gap:8px;margin-bottom:10px">
        <div style="flex:1">
          <label for="date">Date</label>
          <input id="date" class="input" type="date">
        </div>
        <div style="width:120px">
          <label for="time">Time</label>
          <input id="time" class="input" type="time">
        </div>
      </div>

      <div style="margin-bottom:10px">
        <label for="timeIs">Time is</label>
        <select id="timeIs" class="input">
          <option value="Departing">Departing</option>
          <option value="Arriving">Arriving</option>
        </select>
      </div>

      <div style="margin-bottom:12px">
        <label>Modes</label>
        <div id="modes" class="modes">
          <button class="chip active" data-mode="tube">Tube</button>
          <button class="chip active" data-mode="bus">Bus</button>
          <button class="chip active" data-mode="overground">Overground</button>
          <button class="chip active" data-mode="dlr">DLR</button>
          <button class="chip active" data-mode="tram">Tram</button>
          <button class="chip active" data-mode="river">River</button>
          <button class="chip active" data-mode="national-rail">Rail</button>
          <button class="chip active" data-mode="walking">Walking</button>
        </div>
      </div>

      <div style="display:flex;gap:8px">
        <button id="searchBtn" class="btn">Search routes</button>
        <button id="shareBtn" class="chip" title="Copy share link">Copy link</button>
      </div>

      <div id="status" class="small" style="margin-top:10px">Tip: use Place suggestions for best results.</div>

      <div id="results" class="results" aria-live="polite" style="margin-top:12px"></div>

      <div class="footer-note">⚠️ Key is in client-side JS for testing only — move to a server proxy for production.</div>
    </aside>

    <main class="panel">
      <div style="font-weight:700">Route summaries & preview</div>
      <div id="mainInfo" style="margin-top:10px" class="small">Search for journeys — results appear here.</div>
      <div style="height:10px"></div>
      <div id="spare" aria-hidden="true"></div>
    </main>
  </div>
</div>

<!-- modal -->
<div id="modal" class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
  <div class="sheet" role="document">
    <header>
      <div id="modalTitle" style="font-weight:700">Journey details</div>
      <div style="display:flex;gap:8px;align-items:center">
        <div id="fareText" class="small"></div>
        <button id="closeModal" class="chip" aria-label="Close">Close</button>
      </div>
    </header>
    <div class="content" id="modalContent"></div>
  </div>
</div>

<script>
/* ===== CONFIG (temporary testing key) ===== */
const TFL_APP_KEY = "f17d0725d1654338ab02a361fe41abad";

/* ===== LINE/ MODE COLOURS (subset) ===== */
const LINE_COLOURS = {
  central:"#E32017", piccadilly:"#0019A8", victoria:"#00A0E2", jubilee:"#6A7278", northern:"#000000",
  circle:"#FFD300", district:"#00782A", bakerloo:"#B36305", metropolitan:"#9B0056", hammersmithcity:"#F3A9BB",
  waterlooandcity:"#76D0BD", overground:"#EE7C0E", dlr:"#00A4A7", tram:"#84B51A", river:"#00ADEF",
  "national-rail":"#1B365D", bus:"#D50A0A", walking:"#6b7280", tube:"#111827"
};

/* ===== Helpers ===== */
const $ = s => document.querySelector(s);
const byId = id => document.getElementById(id);
const encode = v => encodeURIComponent(v);
function tfl(path, params = {}) {
  const qs = new URLSearchParams(params);
  qs.set("app_key", TFL_APP_KEY);
  return `https://api.tfl.gov.uk${path}?${qs.toString()}`;
}
function debounce(fn, ms=220){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; }
function nowDateISO(){ return new Date().toISOString().slice(0,10); }
function nowTimeHM(){ return new Date().toTimeString().slice(0,5); }
function cap(s){ return s ? s.charAt(0).toUpperCase() + s.slice(1) : ""; }
function safeJSON(obj){ try{ return JSON.parse(JSON.stringify(obj)); }catch{return obj;} }

/* ===== UI Elements ===== */
const fromEl = byId("from"), toEl = byId("to");
const fromDD = byId("fromDD"), toDD = byId("toDD");
const dateEl = byId("date"), timeEl = byId("time"), timeIsEl = byId("timeIs");
const modesEl = byId("modes"), resultsEl = byId("results"), statusEl = byId("status");
const searchBtn = byId("searchBtn"), shareBtn = byId("shareBtn");
const modal = byId("modal"), modalContent = byId("modalContent"), modalTitle = byId("modalTitle"), closeModal = byId("closeModal"), fareText = byId("fareText");
const mainInfo = byId("mainInfo");

/* set defaults */
dateEl.value = nowDateISO();
timeEl.value = nowTimeHM();

/* modes toggling */
modesEl.addEventListener("click", e => {
  const b = e.target.closest(".chip");
  if (!b) return;
  b.classList.toggle("active");
});

/* get selected modes as CSV for TfL query */
function selectedModesCSV(){
  return Array.from(modesEl.querySelectorAll(".chip.active")).map(x=>x.dataset.mode).join(",");
}

/* ===== Autocomplete using Place Search (returns Place IDs) =====
   Using /Place/Search?input=... for flexible matching */
async function placeSearch(q){
  if (!q || q.length < 2) return [];
  try{
    const url = tfl("/Place/Search", { input: q, maxResults: 8, modes: selectedModesCSV() });
    const res = await fetch(url);
    if (!res.ok) return [];
    const json = await res.json();
    return json.matches || [];
  }catch(err){
    console.warn("Place search failed", err);
    return [];
  }
}

/* render dropdown */
function renderDD(box, items, inputEl){
  box.innerHTML = "";
  if (!items || items.length === 0){ box.hidden = true; return; }
  items.forEach(it => {
    const div = document.createElement("div");
    div.className = "dd-item";
    const placeType = it.placeType ? ` • ${it.placeType}` : "";
    div.innerHTML = `<strong>${it.name}</strong><div class="small">${it.id || ""}${placeType}</div>`;
    div.addEventListener("click", ()=> {
      inputEl.value = it.name;
      inputEl.dataset.id = it.id || "";
      box.hidden = true;
    });
    box.appendChild(div);
  });
  box.hidden = false;
}

/* keyboard support for dropdown (up/down/enter) */
function wireDropdown(inputEl, boxEl, fetcher){
  let idx = -1;
  inputEl.addEventListener("keydown", (e) => {
    if (boxEl.hidden) return;
    const items = boxEl.querySelectorAll(".dd-item");
    if (e.key === "ArrowDown"){ idx = Math.min(idx+1, items.length-1); items.forEach((it,i)=>it.style.background = i===idx?"#f0f0f0": ""); e.preventDefault(); }
    if (e.key === "ArrowUp"){ idx = Math.max(idx-1, 0); items.forEach((it,i)=>it.style.background = i===idx?"#f0f0f0": ""); e.preventDefault(); }
    if (e.key === "Enter"){ if (items[idx]) items[idx].click(); e.preventDefault(); }
  });
  inputEl.addEventListener("input", debounce(async () => {
    idx = -1;
    const list = await fetcher(inputEl.value.trim());
    renderDD(boxEl, list, inputEl);
  }, 180));
}

/* attach autocompletes */
wireDropdown(fromEl, fromDD, placeSearch);
wireDropdown(toEl, toDD, placeSearch);

/* hide dropdowns when clicking away */
window.addEventListener("click", e => {
  if (!e.target.closest(".sugg")) { fromDD.hidden = true; toDD.hidden = true; }
});

/* ===== Build and run Journey query =====
   Use Place IDs when available to avoid ambiguous text and 400s. */
searchBtn.addEventListener("click", planJourney);
[fromEl, toEl].forEach(el => el.addEventListener("keydown", e => { if (e.key === "Enter") planJourney(); }));

async function planJourney(){
  resultsEl.innerHTML = `<div class="loading">Planning journey…</div>`;
  mainInfo.textContent = "";
  const fromVal = fromEl.dataset.id || fromEl.value.trim();
  const toVal = toEl.dataset.id || toEl.value.trim();
  if (!fromVal || !toVal){ resultsEl.innerHTML = `<div class="error">Please enter both origin and destination (use suggestions where possible).</div>`; return; }

  const url = tfl(`/Journey/JourneyResults/${encodeURIComponent(fromVal)}/to/${encodeURIComponent(toVal)}`, {
    date: dateEl.value, time: timeEl.value, timeIs: timeIsEl.value, mode: selectedModesCSV(), nationalSearch: "false"
  });

  try{
    const res = await fetch(url);
    if (!res.ok){
      const text = await res.text().catch(()=>"");
      resultsEl.innerHTML = `<div class="error">TfL API returned ${res.status}${text?": "+text:""}</div>`;
      return;
    }
    const data = await res.json();
    if (!data || !data.journeys || data.journeys.length === 0){
      resultsEl.innerHTML = `<div class="error">No journeys found for that query.</div>`;
      return;
    }
    renderJourneySummaries(data.journeys);
    mainInfo.textContent = `Found ${data.journeys.length} route option${data.journeys.length>1?"s":""}. Click one for full details.`;
  }catch(err){
    console.error("planJourney", err);
    resultsEl.innerHTML = `<div class="error">Network error or TfL unreachable. See console for details.</div>`;
  }
}

/* ===== Summaries: mini-map + icons + meta ===== */
function renderJourneySummaries(journeys){
  resultsEl.innerHTML = "";
  journeys.forEach((j, idx) => {
    const card = document.createElement("div"); card.className = "card";
    const left = document.createElement("div"); left.className = "summary-left";
    const sparkHTML = makeSparkSVG(j);
    const sparkWrap = document.createElement("div"); sparkWrap.innerHTML = sparkHTML;
    const text = document.createElement("div"); text.className = "summary-text";
    const title = document.createElement("div"); title.className = "summary-title"; title.textContent = `Journey ${idx+1} • ${j.duration} min`;
    const startTime = j.startDateTime ? new Date(j.startDateTime).toTimeString().slice(0,5) : "";
    const endTime = j.arrivalDateTime ? new Date(j.arrivalDateTime).toTimeString().slice(0,5) : "";
    const sub = document.createElement("div"); sub.className = "small"; sub.textContent = (startTime && endTime) ? `${startTime} → ${endTime} • ${j.legs.length} legs` : `${j.legs.length} legs`;
    text.appendChild(title); text.appendChild(sub);
    left.appendChild(sparkWrap); left.appendChild(text);

    const right = document.createElement("div"); right.className = "mode-icons";
    right.innerHTML = summarizeIconsOrdered(j);

    const summary = document.createElement("div"); summary.className = "summary";
    summary.appendChild(left); summary.appendChild(right);
    card.appendChild(summary);
    card.style.cursor = "pointer";
    card.addEventListener("click", ()=> openJourneyModal(j, idx+1));
    resultsEl.appendChild(card);
  });
}

/* ===== Helpers to create mini map sparkline ===== */
function gatherCoordsFromJourney(journey){
  const pts = [];
  journey.legs.forEach(leg => {
    (leg.path?.lineString || []).forEach(p => pts.push([p.lon, p.lat]));
  });
  return pts;
}
function makeSparkSVG(journey, w=160, h=48, pad=6){
  const pts = gatherCoordsFromJourney(journey);
  if (pts.length < 2) return `<div class="spark small" style="display:flex;align-items:center;justify-content:center;color:${LINE_COLOURS.walking}">No map</div>`;
  let minX=Infinity,maxX=-Infinity,minY=Infinity,maxY=-Infinity;
  pts.forEach(([x,y])=>{ minX=Math.min(minX,x); maxX=Math.max(maxX,x); minY=Math.min(minY,y); maxY=Math.max(maxY,y); });
  const dx = (maxX - minX) || 1, dy = (maxY - minY) || 1;
  const mapX = x => pad + ((x - minX) / dx) * (w - pad*2);
  const mapY = y => pad + (1 - (y - minY) / dy) * (h - pad*2);
  const path = pts.map(([x,y]) => `${mapX(x).toFixed(1)},${mapY(y).toFixed(1)}`).join(" ");
  // single polyline; could colour segments later
  return `<svg class="spark" viewBox="0 0 ${w} ${h}" xmlns="http://www.w3.org/2000/svg"><polyline points="${path}" fill="none" stroke="#111827" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>`;
}

/* ===== Icons & colours for legs ===== */
function modeIdOfLeg(leg){
  return (leg.mode?.id || leg.modeName || "walking").toString().toLowerCase();
}
function getLineId(leg){
  const opt = leg.routeOptions?.[0];
  const candidate = opt?.lineIdentifier?.id || opt?.id || opt?.name || leg.lineId || leg.routeId;
  return candidate ? candidate.toString().toLowerCase().replace(/\s+/g,"").replace(/-/g,"") : "";
}
function iconForLegShort(leg){
  const mode = modeIdOfLeg(leg);
  const lineId = getLineId(leg);
  let label = (mode[0] || "?").toUpperCase();
  let color = LINE_COLOURS[mode] || LINE_COLOURS.tube || "#111";
  if (mode === "tube" && lineId && LINE_COLOURS[lineId]){ color = LINE_COLOURS[lineId]; label = lineId.slice(0,2).toUpperCase(); }
  if (mode === "bus" && leg.routeOptions?.[0]?.name){ label = (leg.routeOptions[0].name || "").replace(/Bus\s*/i, ""); }
  return `<span class="mode-icon" style="border-color:${color};color:${color}">${label}</span>`;
}
function summarizeIconsOrdered(journey){
  const seen = [];
  journey.legs.forEach(leg => {
    const mode = modeIdOfLeg(leg);
    const line = getLineId(leg) || mode;
    if (!seen.includes(line)) seen.push(line);
  });
  return seen.map(l => {
    const col = LINE_COLOURS[l] || LINE_COLOURS[l.split(" ")[0]] || "#6b7280";
    const label = l.length>2 ? l.slice(0,2).toUpperCase() : l.toUpperCase();
    return `<span class="mode-icon" style="border-color:${col};color:${col}">${label}</span>`;
  }).join("");
}

/* ===== Modal with detailed legs/stops/directions ===== */
closeModal.addEventListener("click", ()=> modal.classList.remove("open"));
modal.addEventListener("click", e => { if (e.target === modal) modal.classList.remove("open"); });

function openJourneyModal(journey, num){
  modalTitle.textContent = `Journey ${num} • ${journey.duration} min`;
  fareText.textContent = journey.fare?.displayCost ? `Fare: ${journey.fare.displayCost}` : "";
  modalContent.innerHTML = "";

  // overall summary
  const overview = document.createElement("div");
  overview.className = "small";
  const start = journey.startDateTime ? new Date(journey.startDateTime).toTimeString().slice(0,5) : "";
  const end = journey.arrivalDateTime ? new Date(journey.arrivalDateTime).toTimeString().slice(0,5) : "";
  overview.textContent = (start && end) ? `${start} → ${end} • ${journey.legs.length} legs` : `${journey.legs.length} legs`;
  modalContent.appendChild(overview);

  // each leg
  journey.legs.forEach((leg, idx) => {
    const legDiv = document.createElement("div"); legDiv.className = "leg";
    const mode = modeIdOfLeg(leg);
    const lineId = getLineId(leg);
    const colour = LINE_COLOURS[lineId] || LINE_COLOURS[mode] || LINE_COLOURS.tube;
    const lineName = leg.routeOptions?.[0]?.lineIdentifier?.name || leg.routeOptions?.[0]?.name || leg.lineName || "";

    // title (icon + label)
    const h4 = document.createElement("h4");
    h4.innerHTML = `${iconForLegShort(leg)} <span style="font-weight:700">${cap(mode)}${lineName ? ' — '+lineName : ''}</span>`;
    legDiv.appendChild(h4);

    // times & points
    const depTime = leg.departureTime ? new Date(leg.departureTime).toTimeString().slice(0,5) : "";
    const arrTime = leg.arrivalTime ? new Date(leg.arrivalTime).toTimeString().slice(0,5) : "";
    const depName = leg.departurePoint?.commonName || leg.departurePoint?.name || "";
    const arrName = leg.arrivalPoint?.commonName || leg.arrivalPoint?.name || "";
    const meta = document.createElement("div");
    meta.className = "small";
    meta.textContent = `${depTime}${depName ? ' • '+depName : ''} → ${arrTime}${arrName ? ' • '+arrName : ''}`;
    legDiv.appendChild(meta);

    // instruction
    if (leg.instruction?.summary){
      const p = document.createElement("div");
      p.style.marginTop = "6px";
      p.textContent = leg.instruction.summary;
      legDiv.appendChild(p);
    }

    // stops list (leg.path.stopPoints or leg.stopPoints)
    const stops = (leg.path?.stopPoints || leg.stopPoints || []);
    if (stops && stops.length){
      const sHead = document.createElement("div"); sHead.className = "small"; sHead.style.marginTop = "8px";
      sHead.textContent = `Stops (${stops.length}):`;
      legDiv.appendChild(sHead);
      const ul = document.createElement("ul"); ul.className = "stops";
      stops.forEach(sp => {
        const li = document.createElement("li");
        li.textContent = sp.name || sp.commonName || sp.id || "";
        ul.appendChild(li);
      });
      legDiv.appendChild(ul);
    } else if (mode === "walking" && leg.instruction?.steps?.length){
      const sHead = document.createElement("div"); sHead.className = "small"; sHead.style.marginTop = "8px";
      sHead.textContent = "Walking directions:";
      legDiv.appendChild(sHead);
      const ul = document.createElement("ul"); ul.className = "stops";
      (leg.instruction.steps || []).forEach(st => {
        const li = document.createElement("li");
        li.textContent = st.description || st.summary || "";
        ul.appendChild(li);
      });
      legDiv.appendChild(ul);
    }

    // disruptions
    const disruptions = Array.isArray(leg.disruption) ? leg.disruption : (leg.disruption ? [leg.disruption] : []);
    disruptions.forEach(d => {
      const alert = document.createElement("div");
      alert.className = "small";
      alert.style.marginTop = "6px";
      alert.style.color = "#b45309";
      alert.textContent = `⚠ ${d.description || d.category || 'Disruption'}`;
      legDiv.appendChild(alert);
    });

    // show vehicle/line details (bus number if present)
    if (leg.routeOptions && leg.routeOptions.length){
      const r = leg.routeOptions[0];
      const details = document.createElement("div");
      details.className = "small";
      details.style.marginTop = "6px";
      const routeName = r.name || r.lineIdentifier?.name || r.id || "";
      const direction = r.direction || "";
      details.textContent = `Service: ${routeName}${direction ? ' • ' + direction : ''}`;
      legDiv.appendChild(details);
    }

    modalContent.appendChild(legDiv);
  });

  // overall fare if any
  if (journey.fare?.displayCost || Number.isFinite(journey.fare?.totalCost)){
    const f = document.createElement("div"); f.className = "small"; f.style.marginTop = "8px";
    f.textContent = "Estimated fare: " + (journey.fare.displayCost || (journey.fare.totalCost/100).toFixed(2) + " GBP");
    modalContent.appendChild(f);
  }

  modal.classList.add("open");
}

/* ===== Share link (capture current query) ===== */
shareBtn.addEventListener("click", ()=>{
  const params = new URLSearchParams({
    from: fromEl.value || "", fromId: fromEl.dataset.id || "",
    to: toEl.value || "", toId: toEl.dataset.id || "",
    date: dateEl.value, time: timeEl.value, timeIs: timeIsEl.value, modes: selectedModesCSV()
  });
  const url = `${location.origin}${location.pathname}?${params.toString()}`;
  navigator.clipboard?.writeText(url).then(()=> statusEl.textContent = "Share link copied to clipboard.", ()=> statusEl.textContent = "Unable to copy link.");
});

/* ===== Auto-load from URL if present ===== */
(function preloadFromURL(){
  const qs = new URLSearchParams(location.search);
  if (qs.get("from")) { fromEl.value = qs.get("from"); }
  if (qs.get("fromId")) { fromEl.dataset.id = qs.get("fromId"); }
  if (qs.get("to")) { toEl.value = qs.get("to"); }
  if (qs.get("toId")) { toEl.dataset.id = qs.get("toId"); }
  if (qs.get("date")) dateEl.value = qs.get("date");
  if (qs.get("time")) timeEl.value = qs.get("time");
  if (qs.get("timeIs")) timeIsEl.value = qs.get("timeIs");
  if (qs.get("modes")){
    const want = new Set(qs.get("modes").split(",").map(s=>s.trim()));
    modesEl.querySelectorAll(".chip").forEach(ch => ch.classList.toggle("active", want.has(ch.dataset.mode)));
  }
  if ((fromEl.dataset.id || fromEl.value) && (toEl.dataset.id || toEl.value)){
    planJourney();
  }
})();

</script>
</body>
</html>