<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tracking | RouteFlow London</title>
  <link rel="icon" href="images/New_Routflow_London_Logo.png" type="image/png">
  <link href="https://fonts.googleapis.com/css2?family=Atkinson+Hyperlegible:wght@400;600&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="tracking.css">
  <script src="theme.js" defer></script>
</head>
<body>
  <div id="navbar-container"></div>

  <main class="tracking-shell">
    <section class="tracking-hero card">
      <div class="tracking-hero__content">
        <p class="tracking-hero__eyebrow">Live arrival board</p>
        <h1>Track buses, tubes, trams and river services in real time.</h1>
        <p>Search for any stop or station across the TfL network to see departures update automatically. Save favourites, jot down notes and keep your personal watch list close at hand.</p>
      </div>
      <ul class="tracking-hero__highlights">
        <li>
          <span>Live refresh</span>
          <strong>Every 25 seconds</strong>
        </li>
        <li>
          <span>Modes covered</span>
          <strong>Bus, Tube, DLR, tram, river, rail</strong>
        </li>
        <li>
          <span>Productivity</span>
          <strong>Notes &amp; favourites built-in</strong>
        </li>
      </ul>
    </section>

    <section class="tracking-layout">
      <section class="tracking-board card" aria-live="polite">
        <header class="tracking-board__header">
          <div>
            <h2 id="boardTitle">No stop selected</h2>
            <p id="boardMeta">Type a station or stop name to get started.</p>
          </div>
          <div class="tracking-board__actions">
            <button class="tracking-chip" id="favBtn" type="button">‚òÜ Favourite</button>
            <button class="tracking-chip" id="noteBtn" type="button">üìù Add note</button>
            <span class="tracking-board__timestamp" id="updated"></span>
          </div>
        </header>

        <div class="tracking-search">
          <label class="sr-only" for="q">Search for a stop or station</label>
          <div class="tracking-search__field" id="searchBox">
            <input id="q" type="text" placeholder="Search a station name or paste a Stop ID‚Ä¶" autocomplete="off" />
            <button id="goBtn" type="button" disabled>Search</button>
            <div class="tracking-search__results" id="results"></div>
          </div>
        </div>

        <div class="tracking-board__rows" id="rows">
          <div class="empty">Nothing to show yet.</div>
        </div>
      </section>

      <aside class="tracking-side">
        <article class="tracking-side__card card">
          <h3>Tips for faster searches</h3>
          <ul>
            <li>Paste a StopPoint ID (e.g. 490008660N) to jump straight to arrivals.</li>
            <li>Use the favourites button to pin key stops to your profile dashboard.</li>
            <li>Add notes for rare allocations, disruptions or personal reminders.</li>
          </ul>
        </article>
        <article class="tracking-side__card card">
          <h3>Need planning tools?</h3>
          <p>Switch to the journey planner to compare multi-mode routes with accessibility filters.</p>
          <a class="tracking-side__link" href="planning.html">Open journey planner</a>
        </article>
      </aside>
    </section>
  </main>

  <footer>
    <div class="footer-links">
      <a href="about.html">About</a> |
      <a href="privacy.html">Privacy</a> |
      <a href="terms.html">Terms</a> |
      <a href="contact.html">Contact</a>
    </div>
    <div class="social-icons">
      <a href="https://discord.gg/qVf3nN4Mgq"><i class="fa-brands fa-discord"></i></a>
      <a href="https://www.tiktok.com/@the_bus_father"><i class="fab fa-tiktok"></i></a>
      <a href="https://www.instagram.com/thebusfatherofficial/profilecard/?igsh=NXcybzV3cTA2azBo"><i class="fab fa-instagram"></i></a>
    </div>
    <small>Made for London. Built from scratch.</small>
  </footer>

  <script src="navbar-loader.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
  <script src="main.js"></script>
  <script>
const APP_KEY = "f17d0725d1654338ab02a361fe41abad";
const MODES = "bus,tube,overground,dlr,tram,river-bus,national-rail,elizabeth-line";
const q = document.getElementById('q');
const goBtn = document.getElementById('goBtn');
const results = document.getElementById('results');
const rows = document.getElementById('rows');
const boardTitle = document.getElementById('boardTitle');
const boardMeta = document.getElementById('boardMeta');
const updated = document.getElementById('updated');

let refreshTimer = null;
let currentStop = null;
let refreshSeconds = 25;
let distanceUnit = "metric";

function loadSettings(){
  try{
    const s = JSON.parse(localStorage.getItem('rfSettings')) || {};
    refreshSeconds = Number(s.refreshSeconds) || 25;
    distanceUnit = s.distanceUnit || "metric";
  }catch(e){
    refreshSeconds = 25;
    distanceUnit = "metric";
  }
}
loadSettings();

/* ---------- helpers ---------- */
const sleep = ms => new Promise(r=>setTimeout(r,ms));
function debounce(fn, ms=300){
  let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args),ms); };
}
function minsOrDue(seconds){
  const m = Math.round(seconds/60);
  return m <= 0 ? "Due" : `${m} min`;
}
function formatDistance(m){
  return distanceUnit === "imperial" ? `${(m/1609.344).toFixed(2)} mi` : `${Math.round(m)} m`;
}
function modeClass(mode){
  return `mode-${mode}`;
}
function modeIcon(mode){
  switch(mode){
    case "bus": return "üöç";
    case "tube": return "üöá";
    case "dlr": return "üöà";
    case "overground": return "üü†";
    case "elizabeth-line": return "üü£";
    case "tram": return "üöä";
    case "river-bus": return "‚õ¥Ô∏è";
    case "national-rail": return "üöÜ";
    default: return "üöå";
  }
}
async function fetchJSON(url){
  const res = await fetch(url);
  if(!res.ok) throw new Error(`HTTP ${res.status}`);
  return res.json();
}

/* ---------- search ---------- */
async function search(query){
  if(!query) { results.style.display="none"; return; }

  if(/^\d{8,}[A-Z]?$/i.test(query.trim())){
    results.style.display="none";
    selectStop(query.trim(), "Selected stop");
    return;
  }

  const searchUrl = `https://api.tfl.gov.uk/StopPoint/Search/${encodeURIComponent(query)}?modes=${encodeURIComponent(MODES)}&maxResults=20&app_key=${APP_KEY}`;

  let searchData;
  try{
    searchData = await fetchJSON(searchUrl);
  }catch(e){
    console.error(e);
    results.innerHTML = `<div class="result"><div class="r-main"><div class="r-title">Search failed</div><div class="r-sub">Check network/API key</div></div></div>`;
    results.style.display="block";
    return;
  }

  const matches = (searchData && searchData.matches) ? searchData.matches.slice(0,20) : [];
  if(matches.length === 0){
    results.innerHTML = `<div class="result"><div class="r-main"><div class="r-title">No results</div><div class="r-sub">Try another station name</div></div></div>`;
    results.style.display="block";
    return;
  }

  const detailPromises = matches.map(m => fetchJSON(`https://api.tfl.gov.uk/StopPoint/${m.id}?app_key=${APP_KEY}`).catch(()=>null));
  const details = await Promise.all(detailPromises);

  const entries = [];
  details.forEach(sp => {
    if(!sp) return;
    if(Array.isArray(sp.children) && sp.children.length){
      sp.children.forEach(child=>{
        entries.push(child);
      });
    }else{
      entries.push(sp);
    }
  });

  results.innerHTML = entries.map(sp=>{
    const stopName = sp.commonName || sp.name || "";
    const stopLetter = sp.stopLetter || (sp.additionalProperties||[]).find(p=>p.key==="StopLetter")?.value || "";
    const towards = (sp.additionalProperties||[]).find(p=>p.key==="Towards")?.value || "";
    const mode = (sp.modes && sp.modes[0]) ? sp.modes[0] : "bus";
    const icon = modeIcon(mode);
    const platformText = stopLetter ? `Platform: ${stopLetter}` : `Platform: ‚Äì`;
    const towardsText = towards ? `Towards: ${towards}` : `Towards: ‚Äì`;

    return `
      <div class="result" data-id="${sp.id}" data-name="${stopName}">
        <div class="chip ${modeClass(mode)}" style="color:#fff;border-color:transparent;background:inherit;display:none"></div>
        <div class="r-main">
          <div class="r-title">${icon} ${stopName}</div>
          <div class="r-sub">${platformText} &nbsp;‚Ä¢&nbsp; ${towardsText}</div>
        </div>
      </div>
    `;
  }).join("");

  Array.from(results.querySelectorAll('.result')).forEach(el=>{
    el.addEventListener('click', ()=>{
      const id = el.getAttribute('data-id');
      const name = el.getAttribute('data-name');
      results.style.display="none";
      selectStop(id, name);
    });
  });

  results.style.display="block";
}

/* ---------- arrivals ---------- */
async function loadArrivals(stopId, stopName){
  boardTitle.textContent = stopName || "Live Arrivals";
  boardMeta.textContent = "Fetching live data‚Ä¶";
  rows.innerHTML = `<div class="empty">Loading‚Ä¶</div>`;

  try{
    let data = await fetchJSON(`https://api.tfl.gov.uk/StopPoint/${stopId}/Arrivals?app_key=${APP_KEY}`);

    if(!Array.isArray(data) || data.length===0){
      const info = await fetchJSON(`https://api.tfl.gov.uk/StopPoint/${stopId}?app_key=${APP_KEY}`).catch(()=>null);
      if(info && Array.isArray(info.children) && info.children.length){
        const childReqs = info.children.map(c => fetchJSON(`https://api.tfl.gov.uk/StopPoint/${c.id}/Arrivals?app_key=${APP_KEY}`).catch(()=>[]));
        const childData = (await Promise.all(childReqs)).flat();
        data = childData;
      }
    }

    if(!Array.isArray(data) || data.length===0){
      rows.innerHTML = `<div class="empty">No live arrivals right now.</div>`;
      updated.textContent = new Date().toLocaleTimeString();
      boardMeta.textContent = "";
      return;
    }

    data.sort((a,b)=> a.timeToStation - b.timeToStation);

    rows.innerHTML = data.map(a=>{
      const mode = (a.modeName || "bus");
      const badgeClass = modeClass(mode);
      const icon = modeIcon(mode);
      const eta = minsOrDue(a.timeToStation);
      const line = a.lineName || a.lineId || "";

      const details = [];
      if(a.vehicleId) details.push(`Reg: ${a.vehicleId}`);
      if(typeof a.distance === 'number') details.push(formatDistance(a.distance));
      const detailStr = details.join(' ‚Ä¢ ');

      return `
        <div class="row">
          <div class="badge ${badgeClass}" style="background:var(--${mode.replace(/ /g,'') || 'bus'})">
            ${icon} ${line}
          </div>
          <div class="dest">
            <b>${a.destinationName || a.towards || "‚Äî"}</b>
            <small>${detailStr}</small>
          </div>
          <div class="eta">${eta}</div>
        </div>
      `;
    }).join("");

    updated.textContent = `Updated ${new Date().toLocaleTimeString()}`;
    boardMeta.textContent = "";
  }catch(e){
    console.error(e);
    rows.innerHTML = `<div class="empty">Error loading arrivals.</div>`;
    boardMeta.textContent = "Please try again.";
  }
}

function startRefreshTimer(){
  if(refreshTimer) clearInterval(refreshTimer);
  refreshTimer = setInterval(()=> {
    if(currentStop) loadArrivals(currentStop.id, currentStop.name);
  }, refreshSeconds * 1000);
}

function selectStop(id, name){
  loadSettings();
  currentStop = { id, name };
  q.value = name;
  results.style.display = "none";
  loadArrivals(id, name);
  startRefreshTimer();
}

q.addEventListener('input', debounce((event)=>{
  const value = event.target.value.trim();
  goBtn.disabled = !value;
  search(value);
}, 250));

q.addEventListener('keydown', (event) => {
  if (event.key === 'Enter') {
    event.preventDefault();
    const value = q.value.trim();
    if (value) {
      search(value);
    }
  }
});

goBtn.addEventListener('click', ()=>{
  const value = q.value.trim();
  if(!value) return;
  search(value);
});

document.addEventListener('click', (event)=>{
  if(!event.target.closest('#searchBox')){
    results.style.display = "none";
  }
});

window.addEventListener('beforeunload', () => {
  if(refreshTimer) clearInterval(refreshTimer);
});
  </script>
  <script type="module">
    import { addFavourite } from './favourites.js';
    import { addNote } from './notes.js';

    const favBtn = document.getElementById('favBtn');
    const noteBtn = document.getElementById('noteBtn');

    favBtn?.addEventListener('click', () => {
      const user = firebase.auth()?.currentUser;
      if (!user || !currentStop) {
        alert('Select a stop and sign in first.');
        return;
      }
      addFavourite(user.uid, currentStop);
      favBtn.textContent = '‚òÖ Favourited';
    });

    noteBtn?.addEventListener('click', () => {
      const user = firebase.auth()?.currentUser;
      if (!user || !currentStop) {
        alert('Select a stop and sign in first.');
        return;
      }
      const text = prompt('Enter a note for this stop:');
      if (text) {
        addNote(user.uid, { id: currentStop.id, name: currentStop.name, text });
      }
    });
  </script>
</body>
</html>
